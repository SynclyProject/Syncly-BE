<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>home</title>
    <link rel="stylesheet" type="text/css" th:href="@{/styles/header.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/styles/modal.css}">
    <script src="https://kit.fontawesome.com/5fcc17a7cc.js" crossorigin="anonymous"></script>
    <script defer type="text/javascript" th:src="@{/scripts/common.js}"></script>
    <script defer type="text/javascript" th:src="@{/scripts/modal.js}"></script>
</head>

<body class="container-fluid">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-2">
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#itemModal">
            상품 추가
        </button>
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#brandModal">
            브랜드 추가
        </button>
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#categoryModal">
            카테고리 추가
        </button>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalLabel">상품 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm1">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">이름</label>
                            <input type="text" class="form-control" id="itemName" name="itemName">
                        </div>
                        <div class="mb-3">
                            <label for="purchaseUrl" class="form-label">구매 링크</label>
                            <input type="text" class="form-control" id="purchaseUrl" name="purchaseUrl">
                        </div>
                        <div class="mb-3">
                            <label for="itemImage" class="form-label">아이템 이미지</label>
                            <input type="file" class="form-control" id="itemImage" name="itemImage">
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">카테고리</label>
                            <select class="form-control form-select" id="category" name="category">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="brand" class="form-label">브랜드</label>
                            <select class="form-control form-select" id="brand">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="color" class="form-label">퍼스널컬러</label>
                            <select class="form-control form-select" id="color">
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-light" id="sendItem">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="brandModalLabel">브랜드 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm2">
                        <div class="mb-3">
                            <label for="brandName" class="form-label">이름</label>
                            <input type="text" class="form-control" id="brandName" name="brandName">
                        </div>
                        <div class="mb-3">
                            <label for="homepageUrl" class="form-label">브랜드 홈페이지</label>
                            <input type="text" class="form-control" id="homepageUrl" name="homepageUrl">
                        </div>
                        <div class="mb-3">
                            <label for="brandImage" class="form-label">브랜드 이미지</label>
                            <input type="file" class="form-control" id="brandImage" name="brandImage">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-light" id="sendBrand">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">카테고리 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm3">
                        <div class="mb-3">
                            <label for="category2" class="form-label">카테고리</label>
                            <select class="form-control form-select" id="category2" name="category2">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">이름</label>
                            <input type="text" class="form-control" id="categoryName" name="categoryName">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-light" id="sendCategory">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-hover">
        <thead class="table-light">
        <tr>
            <th class="text-center" scope="col">#</th>
            <th></th>
            <th class="text-center" scope="col">상품명</th>
            <th class="text-center" scope="col">브랜드</th>
            <th class="text-center" scope="col">퍼스널컬러</th>
            <th class="text-center" scope="col">상품관리</th>
        </tr>
        </thead>
        <tbody class="table-group-divider">
        <tr th:each="item : ${pagingItems.getContent()}" th:object="${item}">
            <th class="text-center" th:text="*{id}"></th>
            <td class="text-center"><img th:src="@{/images/items/{id}(id=*{id})}" alt="" style="width:50px;height:50px;"></td>
            <td class="text-center">
                <a th:href="*{purchaseUrl}" th:text="*{name}"></a>
            </td>
            <td class="text-center">
                <a th:href="*{brandHomepageUrl}" th:text="*{brandName}"></a>
            </td>
            <td class="text-center" th:text="*{colorName}"></td>
            <td>
                <div class="d-grid gap-2 d-md-block text-center align-middle">
                    <button class="btn btn-light open-update-modal" data-bs-toggle="modal" data-bs-target="#itemUpdateModal" th:attr="data-item-id=*{id}" type="button">수정</button>
                    <button class="btn btn-light sendItemDelete" th:attr="data-item-id=*{id}" type="button">삭제</button>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="modal fade" id="itemUpdateModal" tabindex="-1" aria-labelledby="itemUpdateModalLabel">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemUpdateModalLabel">상품 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm4">
                        <div class="mb-3 d-flex justify-content-center align-items-center">
                            <img src="" id="itemImagePreview4" alt="이미지" class="img-fluid">
                        </div>
                        <div class="mb-3">
                            <label for="itemName4" class="form-label">이름</label>
                            <input type="text" class="form-control" id="itemName4" name="itemName">
                        </div>
                        <div class="mb-3">
                            <label for="purchaseUrl4" class="form-label">구매 링크</label>
                            <input type="text" class="form-control" id="purchaseUrl4" name="purchaseUrl">
                        </div>
                        <div class="mb-3">
                            <label for="itemImage4" class="form-label">아이템 이미지</label>
                            <input type="file" class="form-control" id="itemImage4" name="itemImage">
                        </div>
                        <div class="mb-3">
                            <label for="category4" class="form-label">카테고리</label>
                            <select class="form-control form-select" id="category4" name="category">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="color4" class="form-label">퍼스널컬러</label>
                            <select class="form-control form-select" id="color4">
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-light" id="sendUpdateItem">수정</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</body>

<nav aria-label="Page navigation example" class="pagination justify-content-center">
    <ul class="pagination">
        <li class="page-item" th:classappend="${pagingItems.isFirst()} ? 'disabled'">
            <a class="page-link" th:href="@{/admin(page=0)}" aria-label="First">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        <li class="page-item" th:classappend="${pagingItems.hasPrevious()} ? '' : 'disabled'">
            <a class="page-link" th:href="@{/admin(page=${pagingItems.getNumber() - 1})}" aria-label="Previous">
                <span aria-hidden="true">&lsaquo;</span>
            </a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, (pagingItems.getTotalPages() > 0 ? pagingItems.getTotalPages() - 1 : 0))}"
            th:classappend="${pagingItems.getNumber() == i} ? 'active'">
            <a class="page-link" th:href="@{/admin(page=${i})}" th:text="${i + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${pagingItems.hasNext()} ? '' : 'disabled'">
            <a class="page-link" th:href="@{/admin(page=${pagingItems.getNumber() + 1})}" aria-label="Next">
                <span aria-hidden="true">&rsaquo;</span>
            </a>
        </li>
        <li class="page-item" th:classappend="${pagingItems.isLast()} ? 'disabled'">
            <a class="page-link" th:href="@{/admin(page=${pagingItems.getTotalPages() - 1})}" aria-label="Last">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>
</html>

<script type="application/javascript">
    $("#itemModal").on("shown.bs.modal", function() {
        $("#itemImage").val("");

        $.ajax({
            url: "/admin/categories",
            type: "GET",
            success: function(response) {
                var categorySelect = $("#category");
                categorySelect.empty()
                    .append($('<option selected></option>').text("선택하세요"));

                function addOptions(categories, depth) {
                    categories.forEach(function(category) {
                        var prefix = '-'.repeat(depth * 2);
                        var option = $("<option></option>")
                            .attr("value", category.id)
                            .text(prefix + " " + category.name);

                        categorySelect.append(option);

                        if (category.subCategories && category.subCategories.length > 0) {
                            addOptions(category.subCategories, depth + 1);
                        }
                    });
                }

                addOptions(response.categories, 0);
            }
        });

        $.ajax({
            url: "/admin/brands",
            type: "GET",
            success: function(response) {
                var brandSelect = $("#brand");
                brandSelect.empty()
                    .append($('<option selected></option>').text("선택하세요"));

                response.forEach(function(brand) {
                    var option = $("<option></option>")
                        .attr("value", brand.id)
                        .text(brand.name);

                    brandSelect.append(option);
                });
            }
        });

        $.ajax({
            url: "/admin/colors",
            type: "GET",
            success: function(response) {
                var colorSelect = $("#color");
                colorSelect.empty()
                    .append($('<option selected></option>').text("선택하세요"));

                response.forEach(function(color) {
                    var option = $("<option></option>")
                        .attr("value", color.id)
                        .text(color.name);

                    colorSelect.append(option);
                });
            }
        });
    });

    $("#sendItem").click(function() {
        var imageFile = $("#itemImage")[0].files[0];

        var formData = new FormData();
        formData.append("image", imageFile);

        var selectedCategory = $("#category").val();
        var selectedBrand = $("#brand").val();
        var selectedColor = $("#color").val();

        var otherData = {
            name: $("#itemName").val(),
            purchaseUrl: $("#purchaseUrl").val(),
            categoryId: selectedCategory,
            brandId: selectedBrand,
            colorId: selectedColor
        };

        formData.append("itemSaveRequest", new Blob([JSON.stringify(otherData)], {type: "application/json"}));

        $.ajax({
            url: "/admin/items",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert("상품 추가 완료");
                $("#itemModal").modal("hide");
                location.reload();
            }
        });
    });

    $("#brandModal").on("shown.bs.modal", function() {
        $("#brandImage").val("");
    });

    $("#sendBrand").click(function() {
        var imageFile = $("#brandImage")[0].files[0];

        var formData = new FormData();
        formData.append("image", imageFile);

        var otherData = {
            name: $("#brandName").val(),
            homepageUrl: $("#homepageUrl").val()
        };

        formData.append("brandSaveRequest", new Blob([JSON.stringify(otherData)], {type: "application/json"}));

        $.ajax({
            url: "/admin/brands",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function() {
                alert("브랜드 추가 완료");
                $("#brandModal").modal("hide");
                location.reload();
            }
        });
    });

    $("#categoryModal").on("shown.bs.modal", function() {
        $("#categoryName").val("");

        $.ajax({
            url: "/admin/categories",
            type: "GET",
            success: function(response) {
                var categorySelect = $("#category2");
                categorySelect.empty()
                    .append($('<option selected></option>').text("선택하세요"));

                function addOptions(categories, depth) {
                    categories.forEach(function(category) {
                        var prefix = '-'.repeat(depth * 2);
                        var option = $("<option></option>")
                            .attr("value", category.id)
                            .text(prefix + " " + category.name);

                        categorySelect.append(option);

                        if (category.subCategories && category.subCategories.length > 0) {
                            addOptions(category.subCategories, depth + 1);
                        }
                    });
                }

                addOptions(response.categories, 0);
            }
        });
    });

    $("#sendCategory").click(function() {
        var categoryName = $("#categoryName").val();
        var selectedCategoryId = $("#category2").val();

        var categoryData = {
            name: categoryName,
            parentCategoryId: selectedCategoryId
        };

        $.ajax({
            url: "/admin/categories",
            type: "POST",
            data: JSON.stringify(categoryData),
            contentType: "application/json",
            success: function(response) {
                alert("카테고리 추가 완료");
                $("#categoryModal").modal("hide");
                location.reload();
            }
        });
    });

    $(document).on("click", ".sendItemDelete", function () {
        let itemId = $(this).data('item-id');

        $.ajax({
            url: `/admin/items/${itemId}`,
            type: "DELETE",
            success: function () {
                alert("삭제를 성공했습니다.");
                location.reload();
            },
            error: function () {
                alert('데이터 삭제를 실패했습니다.');
            }
        });
    });

    $(document).on("click", ".open-update-modal", function() {
        let itemId = $(this).data('item-id');
        const imageRequestUrl = `/images/items/${itemId}`;

        $.ajax({
            url: `/admin/items/${itemId}`,
            type: "GET",
            dataType: "json",
            success: function (response) {
                $("#itemImagePreview4").attr("src", imageRequestUrl);
                $("#itemName4").val(response.name);
                $("#purchaseUrl4").val(response.purchaseUrl);
                $("#sendUpdateItem").data({'item-id': itemId});

                $.ajax({
                    url: "/admin/categories",
                    type: "GET",
                    success: function(categoriesResponse) {
                        var categorySelect = $("#category4");
                        categorySelect.empty();

                        function addOptions(categories, depth) {
                            categories.forEach(function(category) {
                                var prefix = '-'.repeat(depth * 2);
                                var option = $("<option></option>")
                                    .attr("value", category.id)
                                    .text(prefix + " " + category.name);

                                if (category.name === response.categoryName) {
                                    option.attr("selected", "selected");
                                }

                                categorySelect.append(option);

                                if (category.subCategories && category.subCategories.length > 0) {
                                    addOptions(category.subCategories, depth + 1);
                                }
                            });
                        }

                        addOptions(categoriesResponse.categories, 0);
                    }
                });

                $.ajax({
                    url: "/admin/colors",
                    type: "GET",
                    success: function(colorsResponse) {
                        var colorSelect = $("#color4");
                        colorSelect.empty();

                        colorsResponse.forEach(function(color) {
                            var option = $("<option></option>")
                                .attr("value", color.id)
                                .text(color.name);

                            if (color.name === response.colorName) {
                                option.attr("selected", "selected");
                            }

                            colorSelect.append(option);
                        });
                    }
                });
            },
            error: function () {
                alert('데이터를 불러올 수 없습니다.')
            }
        });
    });

    $(document).on("click", "#sendUpdateItem", function() {
        let itemId = $(this).data('item-id');
        var imageFile = $("#itemImage4")[0].files[0];

        var formData = new FormData();
        if (imageFile) {
            formData.append("image", imageFile);
        }

        var selectedCategory = $("#category4").val();
        var selectedColor = $("#color4").val();

        var otherData = {
            name: $("#itemName4").val(),
            purchaseUrl: $("#purchaseUrl4").val(),
            categoryId: selectedCategory,
            colorId: selectedColor
        };

        formData.append("itemUpdateRequest", new Blob([JSON.stringify(otherData)], {type: "application/json"}));

        $.ajax({
            url: `/admin/items/${itemId}`,
            type: "PATCH",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert("상품 수정 완료");
                $("#itemModal").modal("hide");
                location.reload();
            }
        });
    });
</script>